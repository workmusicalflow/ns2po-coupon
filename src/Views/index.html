<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Système de Coupons Cadeaux</title>
    <link href="../css/output.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-gray-800">
          Validation de Coupon Cadeau
        </h1>
        <p class="text-gray-600 mt-2">
          Vérifiez et activez votre coupon pour 100 cartes de visite
        </p>
      </header>

      <main class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 relative">
        <!-- Message de validation -->
        <div
          id="validationMessage"
          class="hidden mb-4 p-4 rounded-md text-sm"
        ></div>
        <form id="couponForm" class="space-y-6">
          <div>
            <label
              for="couponId"
              class="block text-sm font-medium text-gray-700"
              >Numéro de Coupon</label
            >
            <input
              type="text"
              id="couponId"
              name="couponId"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div id="activationFields" class="hidden space-y-4">
            <div>
              <label for="nom" class="block text-sm font-medium text-gray-700"
                >Nom</label
              >
              <input
                type="text"
                id="nom"
                name="nom"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="telephone"
                class="block text-sm font-medium text-gray-700"
                >Téléphone</label
              >
              <input
                type="tel"
                id="telephone"
                name="telephone"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="email"
                name="email"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="entreprise"
                class="block text-sm font-medium text-gray-700"
                >Entreprise</label
              >
              <input
                type="text"
                id="entreprise"
                name="entreprise"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="flex justify-center">
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Valider le Coupon
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      const form = document.getElementById("couponForm");
      const validationMessage = document.getElementById("validationMessage");
      const activationFields = document.getElementById("activationFields");
      const couponInput = document.getElementById("couponId");

      // Fonction pour afficher les messages
      function showMessage(message, isError = false) {
        validationMessage.textContent = message;
        validationMessage.classList.remove(
          "hidden",
          "bg-green-100",
          "text-green-700",
          "bg-red-100",
          "text-red-700"
        );
        validationMessage.classList.add(
          isError ? "bg-red-100" : "bg-green-100",
          isError ? "text-red-700" : "text-green-700"
        );
      }

      // Fonction pour valider le format du code
      function validateCouponFormat(code) {
        return /^[A-Za-z0-9]{5}$/.test(code);
      }

      // Gestionnaire de soumission du formulaire
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const couponCode = couponInput.value.trim();

        // Validation côté client
        if (!validateCouponFormat(couponCode)) {
          showMessage(
            "Le code coupon doit contenir exactement 5 caractères alphanumériques",
            true
          );
          return;
        }

        try {
          // Appel à l'API de validation
          const response = await fetch("/src/validate-coupon", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ code: couponCode }),
          });

          const data = await response.json();

          if (data.valid) {
            // Afficher le message de succès
            showMessage(`Coupon valide pour : ${data.motif}`);
            // Afficher les champs d'activation
            activationFields.classList.remove("hidden");
            // Changer le texte du bouton
            form.querySelector('button[type="submit"]').textContent =
              "Activer le Coupon";
          } else {
            // Afficher l'erreur
            showMessage(data.error, true);
            // Cacher les champs d'activation
            activationFields.classList.add("hidden");
            // Réinitialiser le texte du bouton
            form.querySelector('button[type="submit"]').textContent =
              "Valider le Coupon";
          }
        } catch (error) {
          showMessage(
            "Une erreur est survenue lors de la validation du coupon",
            true
          );
          console.error("Erreur:", error);
        }
      });

      // Réinitialiser le message lors de la modification du code
      couponInput.addEventListener("input", () => {
        validationMessage.classList.add("hidden");
        activationFields.classList.add("hidden");
        form.querySelector('button[type="submit"]').textContent =
          "Valider le Coupon";
      });
    </script>
  </body>
</html>
