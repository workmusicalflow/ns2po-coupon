<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Système de Coupons Cadeaux</title>
    <link href="../css/output.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-gray-800">
          Validation de Coupon Cadeau
        </h1>
        <p class="text-gray-600 mt-2">
          Vérifiez et activez votre coupon pour 100 cartes de visite
        </p>
      </header>

      <main class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 relative">
        <!-- Success View -->
        <div id="successView" class="hidden text-center py-8">
          <div class="mb-6">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Activation Réussie !</h2>
          <p id="successPersonalMessage" class="text-gray-600 mb-4"></p>
          <p id="successMotifMessage" class="text-gray-600 mb-6 font-semibold"></p>
          <p class="text-sm text-gray-500 mb-8">Un email de confirmation vous sera envoyé prochainement avec les détails de votre coupon.</p>
          <button
            type="button"
            id="returnHomeButton"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200"
          >
            Retour à l'accueil
          </button>
        </div>

        <!-- Form View -->
        <div id="formView">
          <!-- Message de validation -->
          <div
            id="validationMessage"
            class="hidden mb-4 p-4 rounded-md text-sm"
          ></div>
        <form id="couponForm" class="space-y-6">
          <div>
            <label
              for="couponId"
              class="block text-sm font-medium text-gray-700"
              >Numéro de Coupon</label
            >
            <input
              type="text"
              id="couponId"
              name="couponId"
              required
              class="mt-1 block w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-gray-900 shadow-sm transition-colors duration-200 placeholder:text-gray-400 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
            />
          </div>

          <div id="activationFields" class="hidden space-y-4">
            <div>
              <label for="nom" class="block text-sm font-medium text-gray-700"
                >Nom</label
              >
              <input
                type="text"
                id="nom"
                name="nom"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-gray-900 shadow-sm transition-colors duration-200 placeholder:text-gray-400 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
              />
            </div>
            <div>
              <label
                for="telephone"
                class="block text-sm font-medium text-gray-700"
                >Téléphone</label
              >
              <input
                type="tel"
                id="telephone"
                name="telephone"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-gray-900 shadow-sm transition-colors duration-200 placeholder:text-gray-400 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="email"
                name="email"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-gray-900 shadow-sm transition-colors duration-200 placeholder:text-gray-400 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
              />
            </div>
            <div>
              <label
                for="entreprise"
                class="block text-sm font-medium text-gray-700"
                >Entreprise</label
              >
              <input
                type="text"
                id="entreprise"
                name="entreprise"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 bg-gray-50 px-3 py-2 text-gray-900 shadow-sm transition-colors duration-200 placeholder:text-gray-400 focus:border-blue-500 focus:bg-white focus:ring-2 focus:ring-blue-500/20"
              />
            </div>
          </div>

          <div class="flex flex-col items-center space-y-4">
            <!-- Boutons de vérification -->
            <div class="flex justify-center space-x-4 w-full">
              <button
                type="button"
                id="verifyButton"
                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 relative"
              >
                <span class="inline-flex items-center">
                  <span class="verify-text">Vérifier la validité</span>
                  <svg class="verify-spinner hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
              </button>
              <button
                type="button"
                id="resetButton"
                class="hidden px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-200"
              >
                Nouvelle vérification
              </button>
            </div>
            
            <!-- Bouton d'utilisation -->
            <button
              type="button"
              id="useButton"
              class="hidden w-full px-4 py-3 bg-green-600 text-white text-lg font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 shadow-lg hover:shadow-xl transition-all duration-200"
            >
              Utiliser ce coupon
            </button>

            <!-- Bouton de validation du formulaire -->
            <button
              type="submit"
              id="submitButton"
              class="hidden w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
            >
              Valider le Coupon
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      const form = document.getElementById("couponForm");
      const validationMessage = document.getElementById("validationMessage");
      const activationFields = document.getElementById("activationFields");
      const couponInput = document.getElementById("couponId");

      // Fonction pour afficher les messages
      function showMessage(message, isError = false) {
        validationMessage.textContent = message;
        validationMessage.classList.remove(
          "hidden",
          "bg-green-100",
          "text-green-700",
          "bg-red-100",
          "text-red-700"
        );
        validationMessage.classList.add(
          isError ? "bg-red-100" : "bg-green-100",
          isError ? "text-red-700" : "text-green-700"
        );
      }

      // Fonction pour valider le format du code
      function validateCouponFormat(code) {
        return /^[A-Za-z0-9]{5}$/.test(code);
      }

      // Validation des champs du formulaire
      function validateForm() {
        const nom = document.getElementById("nom").value.trim();
        const telephone = document.getElementById("telephone").value.trim();
        const email = document.getElementById("email").value.trim();
        const entreprise = document.getElementById("entreprise").value.trim();

        // Validation du nom (au moins 2 caractères)
        if (nom.length < 2) {
          showMessage("Le nom doit contenir au moins 2 caractères", true);
          return false;
        }

        // Validation du téléphone (format international)
        const phoneRegex = /^(?:\+|00)\d{1,4}\s*\d{6,14}$|^0\s*\d{8,9}$/;
        if (!phoneRegex.test(telephone)) {
          showMessage("Le numéro de téléphone n'est pas valide", true);
          return false;
        }

        // Validation de l'email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage("L'adresse email n'est pas valide", true);
          return false;
        }

        // Validation de l'entreprise (au moins 2 caractères)
        if (entreprise.length < 2) {
          showMessage(
            "Le nom de l'entreprise doit contenir au moins 2 caractères",
            true
          );
          return false;
        }

        return true;
      }

      // Fonction pour vérifier la validité du coupon
      async function verifyCoupon(couponCode) {
        const verifyButton = document.getElementById("verifyButton");
        const useButton = document.getElementById("useButton");
        const resetButton = document.getElementById("resetButton");
        
        try {
          // Désactiver le bouton pendant la vérification
          verifyButton.disabled = true;
          verifyButton.querySelector('.verify-text').textContent = "Vérification...";
          verifyButton.querySelector('.verify-spinner').classList.remove('hidden');

          console.log("Envoi du code coupon:", couponCode);
          console.log("URL de la requête:", "/validate-coupon");
          const response = await fetch("/validate-coupon", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ code: couponCode }),
          });

          const responseText = await response.text();
          console.log("Réponse brute:", responseText);
          const data = JSON.parse(responseText);
          console.log("Réponse parsée:", data);

          if (data.valid) {
            // Afficher le message de succès
            showMessage(`✓ Coupon valide et disponible pour : ${data.motif}`, false);
            
            // Désactiver le champ de saisie et le bouton de vérification
            couponInput.disabled = true;
            couponInput.classList.add("bg-gray-100");
            verifyButton.disabled = true;
            verifyButton.classList.add("opacity-50", "cursor-not-allowed", "bg-gray-400");
            
            // Afficher le bouton d'utilisation avec animation
            useButton.classList.remove("hidden");
            useButton.classList.add("animate-fade-in");
            
            // Afficher le bouton de réinitialisation
            resetButton.classList.remove("hidden");
            
            // Animation d'apparition du bouton d'utilisation
            useButton.style.opacity = "0";
            useButton.style.transform = "translateY(20px)";
            setTimeout(() => {
              useButton.style.transition = "all 0.5s ease-out";
              useButton.style.opacity = "1";
              useButton.style.transform = "translateY(0)";
            }, 100);
          } else {
            showMessage(`✗ ${data.error}`, true);
          }
        } catch (error) {
          showMessage("Une erreur est survenue lors de la vérification du coupon", true);
          console.error("Erreur complète:", error);
          console.error("Stack trace:", error.stack);
        } finally {
          verifyButton.disabled = false;
          verifyButton.querySelector('.verify-text').textContent = "Vérifier la validité";
          verifyButton.querySelector('.verify-spinner').classList.add('hidden');
        }
      }

      // Gestionnaire du bouton de vérification
      document.getElementById("verifyButton").addEventListener("click", () => {
        const couponCode = couponInput.value.trim();
        if (!validateCouponFormat(couponCode)) {
          showMessage(
            "Le code coupon doit contenir exactement 5 caractères alphanumériques",
            true
          );
          return;
        }
        verifyCoupon(couponCode);
      });

      // Gestionnaire du bouton d'utilisation
      document.getElementById("useButton").addEventListener("click", () => {
        activationFields.classList.remove("hidden");
        document.getElementById("useButton").classList.add("hidden");
        document.getElementById("submitButton").classList.remove("hidden");
      });

      // Gestionnaire du bouton de réinitialisation
      document.getElementById("resetButton").addEventListener("click", () => {
        form.reset();
        validationMessage.classList.add("hidden");
        activationFields.classList.add("hidden");
        document.getElementById("successView").classList.add("hidden");
        document.getElementById("formView").classList.remove("hidden");
        document.getElementById("useButton").classList.add("hidden");
        document.getElementById("submitButton").classList.add("hidden");
        document.getElementById("resetButton").classList.add("hidden");
        
        // Réactiver le champ de saisie et le bouton de vérification
        couponInput.disabled = false;
        const verifyButton = document.getElementById("verifyButton");
        verifyButton.disabled = false;
        verifyButton.classList.remove("opacity-50", "cursor-not-allowed");
        
        couponInput.focus();
      });

      // Gestionnaire de soumission du formulaire
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const couponCode = couponInput.value.trim();
        const submitButton = form.querySelector('button[type="submit"]');
        const isActivationMode = !activationFields.classList.contains("hidden");

        if (isActivationMode) {
          // Mode activation: valider tous les champs
          if (!validateForm()) {
            return;
          }

          try {
            submitButton.disabled = true;
            submitButton.textContent = "Activation en cours...";

            // Appel à l'API d'activation
            console.log("Envoi des données d'activation:", {
              code: couponCode,
              nom: document.getElementById("nom").value.trim(),
              telephone: document.getElementById("telephone").value.trim(),
              email: document.getElementById("email").value.trim(),
              entreprise: document.getElementById("entreprise").value.trim(),
            });
            const response = await fetch("/activate-coupon", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                code: couponCode,
                nom: document.getElementById("nom").value.trim(),
                telephone: document.getElementById("telephone").value.trim(),
                email: document.getElementById("email").value.trim(),
                entreprise: document.getElementById("entreprise").value.trim(),
              }),
            });

            const data = await response.json();

            if (data.success) {
              // Hide form view and show success view
              document.getElementById("formView").classList.add("hidden");
              const successView = document.getElementById("successView");
              successView.classList.remove("hidden");
              
              // Set personalized messages
              document.getElementById("successPersonalMessage").textContent = 
                `Merci ${document.getElementById("nom").value} ! Votre coupon a été activé avec succès.`;
              document.getElementById("successMotifMessage").textContent = 
                `Vous recevrez bientôt ${data.motif}.`;
              
              // Reset form for next use
              form.reset();
              activationFields.classList.add("hidden");
              submitButton.textContent = "Valider le Coupon";
            } else {
              showMessage(
                data.error || "Une erreur est survenue lors de l'activation",
                true
              );
            }
          } catch (error) {
            showMessage(
              "Une erreur est survenue lors de l'activation du coupon",
              true
            );
            console.error("Erreur:", error);
          } finally {
            submitButton.disabled = false;
          }
        } else {
          // Mode validation: vérifier le format du code
          if (!validateCouponFormat(couponCode)) {
            showMessage(
              "Le code coupon doit contenir exactement 5 caractères alphanumériques",
              true
            );
            return;
          }

          try {
            submitButton.disabled = true;
            submitButton.textContent = "Vérification...";

            // Appel à l'API de validation
            console.log("Validation du code:", couponCode);
            const response = await fetch("/validate-coupon", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ code: couponCode }),
            });

            const data = await response.json();

            if (data.valid) {
              showMessage(`✓ Coupon valide pour : ${data.motif}`);
              activationFields.classList.remove("hidden");
              // Afficher le bouton de validation et changer son texte
              submitButton.classList.remove("hidden");
              submitButton.textContent = "Activer le Coupon";
              // Store motif for success message
              const motifInput = document.createElement("input");
              motifInput.type = "hidden";
              motifInput.id = "motifValue";
              motifInput.value = data.motif;
              form.appendChild(motifInput);
            } else {
              showMessage(data.error, true);
              activationFields.classList.add("hidden");
              submitButton.textContent = "Valider le Coupon";
            }
          } catch (error) {
            showMessage(
              "Une erreur est survenue lors de la validation du coupon",
              true
            );
            console.error("Erreur:", error);
          } finally {
            submitButton.disabled = false;
          }
        }
      });

      // Réinitialiser l'interface lors de la modification du code
      couponInput.addEventListener("input", () => {
        validationMessage.classList.add("hidden");
        activationFields.classList.add("hidden");
        document.getElementById("successView").classList.add("hidden");
        document.getElementById("formView").classList.remove("hidden");
        document.getElementById("useButton").classList.add("hidden");
        document.getElementById("submitButton").classList.add("hidden");
        document.getElementById("resetButton").classList.add("hidden");
      });

      // Gestionnaire du bouton retour à l'accueil
      document.getElementById("returnHomeButton").addEventListener("click", () => {
        // Réinitialiser le formulaire
        form.reset();
        
        // Cacher la vue de succès et afficher le formulaire
        document.getElementById("successView").classList.add("hidden");
        document.getElementById("formView").classList.remove("hidden");
        
        // Réinitialiser tous les champs et états
        validationMessage.classList.add("hidden");
        activationFields.classList.add("hidden");
        document.getElementById("useButton").classList.add("hidden");
        document.getElementById("submitButton").classList.add("hidden");
        document.getElementById("resetButton").classList.add("hidden");
        
        // Réactiver le champ de saisie et le bouton de vérification
        couponInput.disabled = false;
        couponInput.classList.remove("bg-gray-100");
        const verifyButton = document.getElementById("verifyButton");
        verifyButton.disabled = false;
        verifyButton.classList.remove("opacity-50", "cursor-not-allowed", "bg-gray-400");
        
        // Focus sur le champ de saisie
        couponInput.focus();
      });
    </script>
