<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Système de Coupons Cadeaux</title>
    <link href="../css/output.css" rel="stylesheet" />
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <header class="text-center mb-12">
        <h1 class="text-3xl font-bold text-gray-800">
          Validation de Coupon Cadeau
        </h1>
        <p class="text-gray-600 mt-2">
          Vérifiez et activez votre coupon pour 100 cartes de visite
        </p>
      </header>

      <main class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 relative">
        <!-- Success View -->
        <div id="successView" class="hidden text-center py-8">
          <div class="mb-6">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Activation Réussie !</h2>
          <p id="successPersonalMessage" class="text-gray-600 mb-4"></p>
          <p id="successMotifMessage" class="text-gray-600 mb-6 font-semibold"></p>
          <p class="text-sm text-gray-500">Un email de confirmation vous sera envoyé prochainement avec les détails de votre coupon.</p>
        </div>

        <!-- Form View -->
        <div id="formView">
          <!-- Message de validation -->
          <div
            id="validationMessage"
            class="hidden mb-4 p-4 rounded-md text-sm"
          ></div>
        <form id="couponForm" class="space-y-6">
          <div>
            <label
              for="couponId"
              class="block text-sm font-medium text-gray-700"
              >Numéro de Coupon</label
            >
            <input
              type="text"
              id="couponId"
              name="couponId"
              required
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>

          <div id="activationFields" class="hidden space-y-4">
            <div>
              <label for="nom" class="block text-sm font-medium text-gray-700"
                >Nom</label
              >
              <input
                type="text"
                id="nom"
                name="nom"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="telephone"
                class="block text-sm font-medium text-gray-700"
                >Téléphone</label
              >
              <input
                type="tel"
                id="telephone"
                name="telephone"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                type="email"
                id="email"
                name="email"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="entreprise"
                class="block text-sm font-medium text-gray-700"
                >Entreprise</label
              >
              <input
                type="text"
                id="entreprise"
                name="entreprise"
                required
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
              />
            </div>
          </div>

          <div class="flex justify-center">
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Valider le Coupon
            </button>
          </div>
        </form>
      </main>
    </div>

    <script>
      const form = document.getElementById("couponForm");
      const validationMessage = document.getElementById("validationMessage");
      const activationFields = document.getElementById("activationFields");
      const couponInput = document.getElementById("couponId");

      // Fonction pour afficher les messages
      function showMessage(message, isError = false) {
        validationMessage.textContent = message;
        validationMessage.classList.remove(
          "hidden",
          "bg-green-100",
          "text-green-700",
          "bg-red-100",
          "text-red-700"
        );
        validationMessage.classList.add(
          isError ? "bg-red-100" : "bg-green-100",
          isError ? "text-red-700" : "text-green-700"
        );
      }

      // Fonction pour valider le format du code
      function validateCouponFormat(code) {
        return /^[A-Za-z0-9]{5}$/.test(code);
      }

      // Validation des champs du formulaire
      function validateForm() {
        const nom = document.getElementById("nom").value.trim();
        const telephone = document.getElementById("telephone").value.trim();
        const email = document.getElementById("email").value.trim();
        const entreprise = document.getElementById("entreprise").value.trim();

        // Validation du nom (au moins 2 caractères)
        if (nom.length < 2) {
          showMessage("Le nom doit contenir au moins 2 caractères", true);
          return false;
        }

        // Validation du téléphone (format international)
        const phoneRegex = /^(?:\+|00)\d{1,4}\s*\d{6,14}$|^0\s*\d{8,9}$/;
        if (!phoneRegex.test(telephone)) {
          showMessage("Le numéro de téléphone n'est pas valide", true);
          return false;
        }

        // Validation de l'email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage("L'adresse email n'est pas valide", true);
          return false;
        }

        // Validation de l'entreprise (au moins 2 caractères)
        if (entreprise.length < 2) {
          showMessage(
            "Le nom de l'entreprise doit contenir au moins 2 caractères",
            true
          );
          return false;
        }

        return true;
      }

      // Gestionnaire de soumission du formulaire
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const couponCode = couponInput.value.trim();
        const submitButton = form.querySelector('button[type="submit"]');
        const isActivationMode = !activationFields.classList.contains("hidden");

        if (isActivationMode) {
          // Mode activation: valider tous les champs
          if (!validateForm()) {
            return;
          }

          try {
            submitButton.disabled = true;
            submitButton.textContent = "Activation en cours...";

            // Appel à l'API d'activation
            const response = await fetch("/src/activate-coupon", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                code: couponCode,
                nom: document.getElementById("nom").value.trim(),
                telephone: document.getElementById("telephone").value.trim(),
                email: document.getElementById("email").value.trim(),
                entreprise: document.getElementById("entreprise").value.trim(),
              }),
            });

            const data = await response.json();

            if (data.success) {
              // Hide form view and show success view
              document.getElementById("formView").classList.add("hidden");
              const successView = document.getElementById("successView");
              successView.classList.remove("hidden");
              
              // Set personalized messages
              document.getElementById("successPersonalMessage").textContent = 
                `Merci ${document.getElementById("nom").value} ! Votre coupon a été activé avec succès.`;
              document.getElementById("successMotifMessage").textContent = 
                `Vous recevrez bientôt ${data.motif}.`;
              
              // Reset form for next use
              form.reset();
              activationFields.classList.add("hidden");
              submitButton.textContent = "Valider le Coupon";
            } else {
              showMessage(
                data.error || "Une erreur est survenue lors de l'activation",
                true
              );
            }
          } catch (error) {
            showMessage(
              "Une erreur est survenue lors de l'activation du coupon",
              true
            );
            console.error("Erreur:", error);
          } finally {
            submitButton.disabled = false;
          }
        } else {
          // Mode validation: vérifier le format du code
          if (!validateCouponFormat(couponCode)) {
            showMessage(
              "Le code coupon doit contenir exactement 5 caractères alphanumériques",
              true
            );
            return;
          }

          try {
            submitButton.disabled = true;
            submitButton.textContent = "Vérification...";

            // Appel à l'API de validation
            const response = await fetch("/src/validate-coupon", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ code: couponCode }),
            });

            const data = await response.json();

            if (data.valid) {
              showMessage(`Coupon valide pour : ${data.motif}`);
              activationFields.classList.remove("hidden");
              // Delay changing button text slightly
              setTimeout(() => {
                submitButton.textContent = "Activer le Coupon";
              }, 50);
              // Store motif for success message
              const motifInput = document.createElement("input");
              motifInput.type = "hidden";
              motifInput.id = "motifValue";
              motifInput.value = data.motif;
              form.appendChild(motifInput);
            } else {
              showMessage(data.error, true);
              activationFields.classList.add("hidden");
              submitButton.textContent = "Valider le Coupon";
            }
          } catch (error) {
            showMessage(
              "Une erreur est survenue lors de la validation du coupon",
              true
            );
            console.error("Erreur:", error);
          } finally {
            submitButton.disabled = false;
          }
        }
      });

      // Réinitialiser le message lors de la modification du code
      couponInput.addEventListener("input", () => {
        validationMessage.classList.add("hidden");
        activationFields.classList.add("hidden");
        document.getElementById("successView").classList.add("hidden");
        document.getElementById("formView").classList.remove("hidden");
        form.querySelector('button[type="submit"]').textContent =
          "Valider le Coupon";
      });
    </script>
